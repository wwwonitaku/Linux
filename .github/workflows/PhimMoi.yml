name: PhimMoi

on:
  workflow_dispatch:
    inputs:
      slug:
        description: "Slug"
        required: true
      link:
        description: "Link"
        required: true
      token:
        description: "Token"
        required: true
      page:
        description: "Page"
        required: true
      account:
        description: "Account"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # ─────────────────────────────
      # 1. Setup environment
      # ─────────────────────────────
      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl unzip fontconfig
          mkdir -p fonts output tmp

      # ─────────────────────────────
      # 2. Download video & sub
      # ─────────────────────────────
      - name: Download video
        run: |
          curl -L "${{ github.event.inputs.link }}" -o raw_video.mp4

      - name: Download subtitle
        run: |
          curl -L "https://cp.ssplay.net/sub/${{ github.event.inputs.slug }}.ass" -o vi.ass

      # ─────────────────────────────
      # 3. Setup font
      # ─────────────────────────────
      - name: Setup fonts
        run: |
          curl -L https://github.com/wwwonitaku/Linux/raw/main/UTM.zip -o font.zip
          unzip -o font.zip -d fonts
          fc-cache -f

      # ─────────────────────────────
      # 4. Convert to HLS RAW (Giai đoạn 1)
      # ─────────────────────────────
      - name: Convert RAW to HLS
        run: |
          NAME="${{ github.event.inputs.slug }}"
          mkdir -p output_raw
          ffmpeg -i raw_video.mp4 -map 0:v -map 0:a -c copy -f hls \
            -hls_time 5 -hls_list_size 0 \
            -start_number 10001 \
            -hls_playlist_type vod \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${NAME}z-index.png" \
            -hls_segment_filename "output_raw/${NAME}z-index%d.png" \
            "output_raw/${NAME}z.m3u8"

      # ─────────────────────────────
      # 5. Deploy RAW to Cloudflare
      # ─────────────────────────────
      - name: Deploy RAW to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output_raw
          branch: ${{ github.event.inputs.slug }}z

      - name: Verify RAW deployment
        id: verify_raw
        env:
          PROJECT: ${{ github.event.inputs.page }}
          BRANCH: ${{ github.event.inputs.slug }}z
        run: |
          BASE_URL="https://${BRANCH}.${PROJECT}.pages.dev"
          FILE_URL="${BASE_URL}/${BRANCH}.m3u8"
          check () {
            code=$(curl -L -o /dev/null -s -w "%{http_code}" "$FILE_URL")
            echo "RAW HTTP CODE: $code"
            [ "$code" = "200" ]
          }
          echo "Waiting 2 minutes for RAW..."
          sleep 60
          if check; then exit 0; fi
          echo "Wait extra 1 minute..."
          sleep 300
          if check; then exit 0; fi
          exit 1

      - name: Callback RAW
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=RAW" \
            --data-urlencode "key=${{ github.event.inputs.page }}" \
            --data-urlencode "slug=${{ github.event.inputs.slug }}"

      # ─────────────────────────────
      # 6. Encode video (Giai đoạn 2)
      # ─────────────────────────────
      - name: Encode video (Hardsub)
        run: |
          ffmpeg -y -i raw_video.mp4 \
            -vf "ass=vi.ass:fontsdir=fonts" \
            -c:v libx264 -crf 24 -preset medium \
            -pix_fmt yuv420p -maxrate 2500k -bufsize 5000k -b:v 1800k\
            -force_key_frames "expr:gte(t,n_forced*5)" -sc_threshold 0 \
            -c:a aac -b:a 96k -threads 0 \
            final.mp4

      # ─────────────────────────────
      # 7. Convert to HLS Final
      # ─────────────────────────────
      - name: Convert to HLS Final
        run: |
          NAME="${{ github.event.inputs.slug }}"
          mkdir -p output
          ffmpeg -i final.mp4 -c copy -f hls \
            -hls_time 5 -hls_list_size 0 \
            -start_number 10001 \
            -hls_playlist_type vod \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" \
            "output/${NAME}.m3u8"

      # ─────────────────────────────
      # 8. Auto pick best thumbnail
      # ─────────────────────────────
      - name: Auto pick best thumbnail
        continue-on-error: true
        run: |
          set +e
          NAME="${{ github.event.inputs.slug }}"
          best=""
          best_size=0
          for i in 4 5 6 7 8; do
            ffmpeg -y -i raw_video.mp4 -ss 00:0$i:00 \
              -vframes 1 -vf "scale=-1:1080" \
              tmp/t$i.jpg >/dev/null 2>&1 || continue
            [ ! -f tmp/t$i.jpg ] && continue
            size=$(stat -c%s tmp/t$i.jpg 2>/dev/null || echo 0)
            if [ "$size" -gt "$best_size" ]; then
              best_size=$size
              best="tmp/t$i.jpg"
            fi
          done
          if [ -n "$best" ]; then
            cp "$best" "output/${NAME}-index.jpg"
          fi

      # ─────────────────────────────
      # 9. Deploy Final to Cloudflare
      # ─────────────────────────────
      - name: Deploy Final to Cloudflare Pages
        id: deploy_final
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.slug }}

      - name: Verify Final deployment
        id: verify
        continue-on-error: true
        env:
          PROJECT: ${{ github.event.inputs.page }}
          BRANCH: ${{ github.event.inputs.slug }}
        run: |
          set -e
          BASE_URL="https://${BRANCH}.${PROJECT}.pages.dev"
          FILE_URL="${BASE_URL}/${BRANCH}.m3u8"
          check () {
            code=$(curl -L -o /dev/null -s -w "%{http_code}" "$FILE_URL")
            echo "FINAL HTTP CODE: $code"
            [ "$code" = "200" ]
          }
          echo "Waiting 5 minutes..."
          sleep 120
          if check; then exit 0; fi
          echo "Wait extra 3 minutes..."
          sleep 300
          if check; then exit 0; fi
          exit 1

      - name: Deploy Final Retry
        if: steps.verify.outcome == 'failure'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.slug }}
      
      # ─────────────────────────────
      # 10. Callbacks
      # ─────────────────────────────
      - name: Callback success
        if: success()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=ok" \
            --data-urlencode "key=${{ github.event.inputs.page }}" \
            --data-urlencode "slug=${{ github.event.inputs.slug }}"

      - name: Callback error
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=error" \
            --data-urlencode "slug=${{ github.event.inputs.slug }}"
