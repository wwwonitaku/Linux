name: Video to M3U8 (Hard Sub Oswald) and Deploy

on:
  workflow_dispatch:
    inputs:
      m3u8link:
        description: 'Link M3U8'
        required: true
      sublink:
        description: 'Link subtitle (.srt/.vtt)'
        required: true
      name:
        description: 'Tên file để lưu và deploy'
        required: true
      token:
        description: 'Token'
        required: true
      projectName:
        description: 'projectName'
        required: true
      accountId:
        description: 'AccountID'
        required: true
      bitrate:
        description: 'Bitrate video (ví dụ: 1800k trong khoảng 1500k–2000k)'
        required: false
        default: '1800k'
      testDuration:
        description: 'Thời lượng file test (giây)'
        required: false
        default: '60'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl git jq

      - name: Install Oswald font (auto from Google Fonts ZIP)
        run: |
          set -e
          mkdir -p $HOME/.local/share/fonts
          curl -L "https://fonts.google.com/download?family=Oswald" -o Oswald.zip
          unzip -o Oswald.zip -d $HOME/.local/share/fonts
          fc-cache -f -v



      - name: Download video from M3U8
        run: |
          set -e
          SRC="${{ github.event.inputs.name }}-source.mp4"
          ffmpeg -i "${{ github.event.inputs.m3u8link }}" -c copy -bsf:a aac_adtstoasc "${{ github.event.inputs.name }}-source.mp4"

      - name: Verify video file (size + ffprobe + wait)
        run: |
          set +e
          FILE="${{ github.event.inputs.name }}-source.mp4"

          # Đợi file xuất hiện
          for i in {1..10}; do
            if [ -f "$FILE" ]; then
              break
            fi
            echo "File chưa xuất hiện, chờ 1s..."
            sleep 1
          done

          # Kiểm tra dung lượng >0
          SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo 0)
          echo "File size: $SIZE bytes"
          if [ $SIZE -eq 0 ]; then
            echo "File chưa tải xong, retry download..."
            ffmpeg -y -i "${{ github.event.inputs.m3u8link }}" -c copy "$FILE"
            SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo 0)
            echo "File size after retry: $SIZE bytes"
            if [ $SIZE -eq 0 ]; then
              echo "File vẫn rỗng sau retry"
              exit 1
            fi
          fi

          # Kiểm tra dung lượng tối thiểu 1MB
          if [ $SIZE -lt 1000000 ]; then
            echo "File quá nhỏ (<1MB), retry download..."
            ffmpeg -y -i "${{ github.event.inputs.m3u8link }}" -c copy "$FILE"
            SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo 0)
            echo "File size after retry: $SIZE bytes"
            if [ $SIZE -lt 1000000 ]; then
              echo "File vẫn quá nhỏ sau retry"
              exit 1
            fi
          fi

          # Kiểm tra bằng ffprobe
          ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$FILE"
          if [ $? -ne 0 ]; then
            echo "Video file invalid, retrying download..."
            ffmpeg -y -i "${{ github.event.inputs.m3u8link }}" -c copy "$FILE"
            ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$FILE"
            if [ $? -ne 0 ]; then
              echo "Video file vẫn invalid sau retry"
              exit 1
            fi
          fi
          set -e

      - name: Download subtitle
        run: |
          set -e
          curl -L "${{ github.event.inputs.sublink }}" -o "${{ github.event.inputs.name }}.subraw"

      - name: Normalize subtitle to .srt (handles .vtt)
        run: |
          set -e
          RAW="${{ github.event.inputs.name }}.subraw"
          OUT="${{ github.event.inputs.name }}.srt"
          # Convert nếu là .vtt; nếu đã .srt thì ffmpeg vẫn copy đúng
          ffmpeg -y -i "$RAW" "$OUT" || (mv "$RAW" "$OUT")
          if [ ! -s "$OUT" ]; then
            echo "Subtitle invalid or empty"
            exit 1
          fi
      - name: Render full hard-sub video (Oswald, yellow + black outline)
        run: |
          set -e
          SRC="${{ github.event.inputs.name }}-source.mp4"
          SUB="${{ github.event.inputs.name }}.srt"
          OUT="${{ github.event.inputs.name }}-sub.mp4"
          ffmpeg -y -i "$SRC" \
            -vf "subtitles=${SUB}:force_style='Fontname=Oswald,FontSize=24,PrimaryColour=&H0000FFFF,OutlineColour=&H00000000,BorderStyle=1,Outline=1,Shadow=0,Alignment=1'" \
            -c:v libx264 -preset fast -b:v ${{ github.event.inputs.bitrate }} -profile:v high -level 4.0 \
            -c:a aac -b:a 128k -movflags +faststart \
            "$OUT"

      - name: Convert to HLS with .png segment names
        run: |
          set -e
          IN="${{ github.event.inputs.name }}-sub.mp4"
          mkdir -p output
          # Dùng bitstream filter để đảm bảo h264 ở Annex B khi đóng gói TS
          ffmpeg -y -i "$IN" \
            -c:v copy -bsf:v h264_mp4toannexb -c:a copy \
            -hls_time 8 -hls_flags split_by_time+independent_segments -hls_list_size 0 \
            -start_number 10001 \
            -hls_segment_filename "output/${{ github.event.inputs.name }}-index%05d.png" \
            -f hls "output/${{ github.event.inputs.name }}.m3u8"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.accountId }}
          projectName: ${{ github.event.inputs.projectName }}
          directory: ./output
          branch: ${{ github.event.inputs.name }}

      - name: Callback success
        if: success()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=ok" \
            --data-urlencode "key=${{ github.event.inputs.projectName }}" \
            --data-urlencode "slug=${{ github.event.inputs.name }}"

      - name: Callback error
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=error" \
            --data-urlencode "slug=${{ github.event.inputs.name }}"
