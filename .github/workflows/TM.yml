name: AHiHi -> CF (Audio Sync)

on:
  workflow_dispatch:
    inputs:
      slug: { required: true }
      token: { required: true }
      page: { required: true }
      account: { required: true }
      link_video:
        description: "Original video link"
        required: true
      link_audio_video:
        description: "Narration video ID"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          
      - name: Setup Python
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl git jq unzip
          sudo apt install -y python3 python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install numpy scipy librosa soundfile

      - name: Download abyss-dl.jar
        run: |
          mkdir -p tools
          curl -L \
            -o tools/abyss-dl.jar \
            https://github.com/abdlhay/AbyssVideoDownloader/releases/latest/download/abyss-dl.jar

      - name: Download original video
        run: |
          ffmpeg -y -i "${{ github.event.inputs.link_video }}" -c copy -bsf:a aac_adtstoasc original.mp4

      - name: Download narration video (abyss-dl)
        run: |
          FILE="narration.mp4"
          java -jar tools/abyss-dl.jar \
            "${{ github.event.inputs.link_audio_video }}" h -o "$FILE"

      - name: Extract audio
        run: |
          ffmpeg -y -i original.mp4 -ac 1 -ar 16000 original.wav
          ffmpeg -y -i narration.mp4 -ac 1 -ar 16000 narration.wav

      - name: Align audio & build final track
        run: |
          python3 <<'EOF'
          import librosa, numpy as np, soundfile as sf
          from scipy.signal import correlate

          sr = 16000
          orig, _ = librosa.load("original.wav", sr=sr)
          nar, _ = librosa.load("narration.wav", sr=sr)

          print("[INFO] Calculating cross-correlation...")
          corr = correlate(nar, orig, mode="valid")
          offset = int(np.argmax(corr))
          print(f"[INFO] Offset = {offset/sr:.2f}s")

          final = orig.copy()
          length = min(len(nar), len(orig) - offset)

          if length > 0:
              final[offset:offset+length] = nar[:length]

          sf.write("final_audio.wav", final, sr)
          print("[DONE] Final audio generated")
          EOF

      - name: Mux final video
        run: |
          OUT="${{ github.event.inputs.slug }}.mp4"
          ffmpeg -y \
            -i original.mp4 \
            -i final_audio.wav \
            -map 0:v \
            -map 1:a \
            -c:v copy \
            -c:a aac -b:a 128k \
            "$OUT"

      - name: Convert to HLS
        run: |
          NAME="${{ github.event.inputs.slug }}"
          mkdir -p output
          ffmpeg -i "${NAME}.mp4" -c copy -f hls \
            -hls_time 5 \
            -hls_list_size 0 \
            -start_number 10001 \
            -hls_playlist_type vod \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" \
            "output/${NAME}.m3u8"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.slug }}
