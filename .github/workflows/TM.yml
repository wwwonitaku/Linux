name: AHiHi -> CF (Audio Sync)

on:
  workflow_dispatch:
    inputs:
      type: { required: true }
      slug: { required: true }
      ss: { required: true }
      ep: { required: true }
      token: { required: true }
      page: { required: true }
      account: { required: true }
      link_video: { description: "Original video", required: true }
      link_audio_video: { description: "Narration video", required: true }

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: |
          sudo apt update
          sudo apt install -y ffmpeg python3 python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install numpy scipy librosa soundfile

      - name: Download videos
        run: |
          ffmpeg -y -i "${{ github.event.inputs.link_video }}" -c copy original.mp4
          ffmpeg -y -i "${{ github.event.inputs.link_audio_video }}" -c copy narration.mp4

      - name: Extract audio
        run: |
          ffmpeg -y -i original.mp4 -ac 1 -ar 16000 original.wav
          ffmpeg -y -i narration.mp4 -ac 1 -ar 16000 narration.wav

      - name: Align & build final audio
        run: |
          python3 <<'EOF'
          import librosa, numpy as np, soundfile as sf
          from scipy.signal import correlate

          orig, sr = librosa.load("original.wav", sr=16000)
          nar, sr = librosa.load("narration.wav", sr=16000)

          print("[INFO] Finding offset...")
          corr = correlate(nar, orig, mode="valid")
          offset = np.argmax(corr)
          print("[INFO] Offset samples:", offset)

          final = orig.copy()
          end = min(len(nar), len(orig) - offset)
          final[offset:offset+end] = nar[:end]

          sf.write("final_audio.wav", final, sr)
          print("[DONE] Audio aligned")
          EOF

      - name: Mux final video
        run: |
          ffmpeg -y \
            -i original.mp4 \
            -i final_audio.wav \
            -map 0:v \
            -map 1:a \
            -c:v copy \
            -c:a aac -b:a 128k \
            final.mp4

      - name: HLS
        run: |
          NAME="${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}"
          mkdir -p output
          ffmpeg -i final.mp4 -c copy -f hls \
            -hls_time 5 -hls_list_size 0 -start_number 10001 \
            -hls_playlist_type vod \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" \
            "output/${NAME}.m3u8"

      - name: Deploy Cloudflare
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}
