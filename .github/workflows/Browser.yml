name: Browser Automation Inline

on:
  workflow_dispatch:

jobs:
  run-browser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Run Puppeteer inline
        run: |
          node - <<'EOF'
          const puppeteer = require('puppeteer');

          (async () => {
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            // Truy cập blog
            await page.goto('https://hhtm.cc/', { waitUntil: 'networkidle2' });
            console.log('Page title:', await page.title());

            // Chờ 1 phút cho trang load xong hẳn
            await page.waitForTimeout(60000);

            // Click vào link đầu tiên
            try {
              await page.click('a');
              await page.waitForNavigation({ waitUntil: 'networkidle2' });
              console.log('Navigated to:', page.url());
            } catch (err) {
              console.error('Error clicking first link:', err);
            }

            // Quay lại
            await page.goBack({ waitUntil: 'networkidle2' });

            // Click vào bài viết đầu tiên
            const posts = await page.$$('.post-title a');
            if (posts.length > 0) {
              await posts[0].click();
              await page.waitForNavigation({ waitUntil: 'networkidle2' });
              console.log('Clicked post, now at:', page.url());
            }

            // Chụp ảnh màn hình
            await page.screenshot({ path: 'result.png', fullPage: true });

            await browser.close();
          })();
          EOF

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshot
          path: result.png
